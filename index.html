<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Image Viewer — By Liam</title>
  <meta name="color-scheme" content="light dark">

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="//unpkg.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">

  <style>
    :root{
      --bg: #f6f7fb;
      --bg2: #f6f7fb;
      --text: #0f172a;
      --muted: #70648b;
      --border: #e2e8f0;
      --shadow: 0 10px 20px rgba(2,8,23,.05), 0 2px 6px rgba(2,8,23,.06);
      --rad: 14px;
      --brand: #1e0f2a;
      --ring: #6f30b8;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#2f1b3f; --bg2:#1e0f2a; --text:#f8fafc; --muted:#94a3b8; --border:#14091d; --shadow:none; --brand:#fcf8fb; --ring:#541e92; }
      .shadow { box-shadow: none !important; }
    }
    @media (prefers-reduced-motion: reduce){
      *{animation: none !important; transition: none !important}
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(to bottom,var(--bg),#72558a 30%,var(--bg));
      font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text)
    }
    .container{max-width:1120px;margin:0 auto;padding:16px}
    header.sticky{
      position:sticky;top:0;z-index:30;
      backdrop-filter:saturate(1.4) blur(6px);
      background:color-mix(in oklab, var(--bg2) 86%, transparent);
      border-bottom:1px solid var(--border)
    }
    .row{display:flex;gap:10px;align-items:center}
    .grow{flex:1 1 auto}
    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;border-radius:12px;padding:10px 14px;border:1px solid var(--border);background:var(--bg2);color:var(--text);box-shadow:var(--shadow);cursor:pointer;transition:transform .12s ease, filter .12s ease, box-shadow .2s ease}
    .btn:hover{filter:brightness(0.98); box-shadow:0 12px 24px rgba(2, 2, 2, 0.08), 0 4px 12px rgba(2,8,23,.06)}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.primary{background:var(--bg2); color:#fff; border-color:transparent}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:var(--bg2);border-radius:12px;padding:6px 10px}
    .input{border:1px solid var(--border);background:var(--bg2);border-radius:12px;padding:10px 12px; width:100%; color:var(--text); transition: box-shadow .15s ease, border-color .15s ease}
    .input:focus{outline:none; border-color:color-mix(in oklab, var(--ring) 60%, var(--border)); box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 20%, transparent)}
    .toolbar{gap:10px}
    .select{appearance:none}
    .grid{display:grid; gap:16px}
    .tile{
      position:relative; overflow:hidden; border-radius:12px; border:1px solid var(--border);
      background:var(--bg2); box-shadow:var(--shadow); transform:translateY(8px) scale(.98); opacity:0;
      content-visibility:auto; contain-intrinsic-size: 260px 220px;
    }
    .tile.reveal{animation:tileIn .5s cubic-bezier(.2,.8,.2,1) forwards; animation-delay: calc(var(--i, 0) * 20ms)}
    .thumb{
      width:100%;height:0;padding-bottom:75%;display:block;overflow:hidden;
      position:relative; /* constrain absolutely-positioned img to the thumb box */
    }
    .thumb>img{
      width:100%;height:100%;
      object-fit:contain;             /* << contain so art stays inside the box */
      display:block;position:absolute;inset:0;
      transform:scale(1.0); transition:transform .28s ease; will-change: transform;
      background:transparent;
    }
    .tile:hover .thumb>img{transform:scale(1.03)}
    .tile-footer{display:flex;justify-content:space-between;align-items:center;padding:10px}
    .meta{min-width:0}
    .name{font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .muted{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:6px;opacity:0; transform:translateY(4px); transition:opacity .18s ease, transform .18s ease}
    .tile:hover .actions{opacity:1; transform:translateY(0)}
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;padding:2vh 2vw;z-index:60}
    .lightbox.open{display:flex;animation:fadeIn .18s ease}
    /* fixed-size stage for consistent full-view size */
    .lightbox-inner{
      position:relative;
      width:min(1200px, 90vw);
      height:min(84vh, 84svh);
      animation:zoomIn .28s cubic-bezier(.22,1,.36,1);
    }
    .lightbox img{
      width:100%;height:100%;
      object-fit:contain;
      border-radius:16px;
      background:transparent;          /* << keep PNG transparency */
      box-shadow:0 20px 60px rgba(0,0,0,.4);
    }
    .lb-top{
      position:absolute;left:12px;right:12px;top:8px;display:flex;justify-content:space-between;align-items:center;color:#fff;gap:8px;
      z-index:2;
    }
    .lb-btn{border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.1);color:#fff;border-radius:10px;padding:6px 10px;backdrop-filter:saturate(1.2) blur(2px); transition: transform .12s ease}
    .lb-btn:active{transform:scale(.98)}
    .nav{position:absolute;inset-block:0;display:flex;align-items:center;color:#fff}
    .nav button{border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);border-radius:12px;padding:10px;cursor:pointer; transition: transform .12s ease}
    .nav button:active{transform:scale(.98)}
    .nav.left{left:8px}.nav.right{right:8px}
    .drop{margin-top:18px;margin-bottom:28px;border:2px dashed var(--border);border-radius:20px;background:var(--bg2);padding:36px;text-align:center;color:var(--muted);cursor:pointer;transition:border-color .2s ease, transform .15s ease, box-shadow .2s ease, background .2s ease}
    .drop.highlight{border-color:transparent; transform:scale(1.01); background:linear-gradient(var(--bg2), var(--bg2)) padding-box, conic-gradient(from 0deg at 50% 50%, var(--ring), transparent 45%, var(--ring) 55%, transparent 90%, var(--ring)) border-box; box-shadow:0 12px 30px rgba(59,130,246,.18)}
    .list{border-radius:14px;overflow:hidden;border:1px solid var(--border);background:var(--bg2)}
    .list .head,.list .row{display:grid;grid-template-columns:6fr 2fr 2fr 2fr;align-items:center}
    .list .head{padding:10px 14px;border-bottom:1px solid var(--border); color:var(--muted); font-size:12px; font-weight:600}
    .list .row{
      padding:10px 14px;border-bottom:1px solid color-mix(in oklab, var(--border) 70%, transparent); opacity:0; transform:translateY(6px);
      content-visibility:auto; contain-intrinsic-size: 72px 54px;
    }
    .list .row.reveal{animation:rowIn .4s cubic-bezier(.2,.8,.2,1) forwards; animation-delay: calc(var(--i, 0) * 18ms)}
    .list .row:last-child{border-bottom:0}
    .preview{width:72px;height:54px;border-radius:10px;border:1px solid var(--border);overflow:hidden; background:#f1f5f9; flex-shrink:0}
    .preview img{width:100%;height:100%;object-fit:cover;display:block}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes tileIn{from{opacity:0; transform:translateY(12px) scale(.96)} to{opacity:1; transform:translateY(0) scale(1)}}
    @keyframes rowIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
    @keyframes zoomIn{from{opacity:.9; transform:translateY(8px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}
    .note{font-size:12px;color:var(--muted);text-align:center;margin:28px 0}
    .icon-btn{display:inline-flex;align-items:center;gap:6px;border-radius:10px;border:1px solid var(--border);background:var(--bg2);padding:6px 8px;cursor:pointer; transition: transform .12s ease}
    .icon-btn:active{transform:scale(.98)}
    .spacer{flex:1}
    .hidden{display:none}
    .range{accent-color:var(--ring)}
    .kbd{font:12px ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; border:1px solid var(--border); background:var(--bg2); padding:2px 6px; border-radius:6px}
  </style>

  <script src="https://unpkg.com/lucide@latest" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" defer></script>
</head>
<body>
  <header class="sticky">
    <div class="container row" style="padding:12px 16px;">
      <div class="row" style="gap:10px;">
        <div class="chip"><i data-lucide="upload"></i><b>Image Viewer</b></div>
      </div>
      <div class="row grow toolbar">
        <div class="row grow" style="position:relative">
          <i data-lucide="search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.6"></i>
          <input id="search" class="input" style="padding-left:36px" placeholder="Search by filename…">
          <button id="clearSearch" class="icon-btn" title="Clear"><i data-lucide="x"></i></button>
        </div>
        <div class="chip">
          <i data-lucide="sliders-horizontal"></i>
          <label for="density" class="muted">Density</label>
          <input id="density" class="range" type="range" min="140" max="320" step="10" value="220">
        </div>
        <select id="sort" class="input select" style="max-width:180px">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="name-asc">Name A→Z</option>
          <option value="name-desc">Name Z→A</option>
          <option value="size">Size (large first)</option>
        </select>
        <div class="row">
          <button id="gridBtn" class="btn"><i data-lucide="layout-grid"></i> Grid</button>
          <button id="listBtn" class="btn"><i data-lucide="rows"></i> List</button>
        </div>
        <div class="spacer"></div>
        <input id="fileInput" class="hidden" type="file" accept="image/*" multiple>
        <button id="uploadBtn" class="btn primary"><i data-lucide="upload"></i> Upload images</button>
        <button id="zipBtn" class="btn" disabled><i data-lucide="archive"></i> Export ZIP</button>
        <button id="clearBtn" class="btn">Clear all</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="drop" class="drop">
      <div><i data-lucide="upload"></i></div>
      <div style="font-weight:600;margin-top:6px">Drag & drop images here</div>
      <div class="muted">or click to browse your files</div>
      <div class="muted" style="margin-top:8px">Hint: press <span class="kbd">A</span>/<span class="kbd">D</span> to switch between images</div>
    </div>

    <section id="content"></section>

    <div class="note"><p style="color: rgba(255, 255, 255, 0.678);">Hey, this runs entirely in your browser. Images are kept locally, no worries :3</p></div>
  </main>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Image viewer">
    <div class="lightbox-inner">
      <img id="lb-img" alt="Preview" decoding="async" fetchpriority="low">
      <div class="lb-top">
        <div id="lb-title" class="muted" style="font-size:13px"></div>
        <div class="row">
          <a id="lb-save" class="lb-btn" download><span style="vertical-align:middle">Save</span></a>
          <button id="lb-remove" class="lb-btn" type="button">Remove</button>
          <button id="lb-close" class="lb-btn" type="button">Close</button>
        </div>
      </div>
      <div class="nav left"><button id="lb-prev" title="Previous" type="button"><i data-lucide="chevron-left"></i></button></div>
      <div class="nav right"><button id="lb-next" title="Next" type="button"><i data-lucide="chevron-right"></i></button></div>
    </div>
  </div>

<script defer>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const svg = (name, attrs={}) => {
    try{
      return lucide?.icons?.[name]?.toSvg
        ? lucide.icons[name].toSvg({width:16, height:16, ...attrs})
        : '';
    }catch{ return ''; }
  };
  const bytesToNice = (num) => {
    if (num < 1024) return num + " B";
    const units = ["KB","MB","GB"];
    let i=-1;
    do { num /= 1024; i++; } while (num >= 1024 && i < units.length-1);
    return (num >= 100 ? num.toFixed(0) : num >= 10 ? num.toFixed(1) : num.toFixed(2)) + " " + units[i];
  };
  const debounce = (fn, ms=120) => { let t; return(...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  const state = {
    items: [],
    query: "",
    sortBy: "newest",
    tile: 220,
    view: "grid",
    viewer: { open:false, index:0 },
    isZipping: false
  };

  const content = $("#content");
  const search = $("#search");
  const clearSearch = $("#clearSearch");
  const density = $("#density");
  const sortSel = $("#sort");
  const gridBtn = $("#gridBtn");
  const listBtn = $("#listBtn");
  const fileInput = $("#fileInput");
  const uploadBtn = $("#uploadBtn");
  const zipBtn = $("#zipBtn");
  const clearBtn = $("#clearBtn");
  const drop = $("#drop");

  const lightbox = $("#lightbox");
  const lbImg = $("#lb-img");
  const lbTitle = $("#lb-title");
  const lbSave = $("#lb-save");
  const lbRemove = $("#lb-remove");
  const lbClose = $("#lb-close");
  const lbPrev = $("#lb-prev");
  const lbNext = $("#lb-next");

  document.addEventListener('DOMContentLoaded', ()=> {
    if (window.lucide?.createIcons) lucide.createIcons();
  });

  function addFiles(fileList){
    const now = Date.now();
    const images = Array.from(fileList).filter(f => f.type.startsWith("image/"));
    if (!images.length) return;
    const existingKey = new Set(state.items.map(p => p.name+"-"+p.size));
    for (const f of images){
      const key = f.name+"-"+f.size;
      if (existingKey.has(key)) continue;
      const src = URL.createObjectURL(f);
      state.items.push({ id: now+"-"+Math.random().toString(36).slice(2), name:f.name, size:f.size, type:f.type, addedAt: now, src });
    }
    render();
  }
  function getFiltered(){
    const q = state.query.trim().toLowerCase();
    let res = q ? state.items.filter(it => it.name.toLowerCase().includes(q)) : state.items.slice();
    switch(state.sortBy){
      case "name-asc": res.sort((a,b)=>a.name.localeCompare(b.name)); break;
      case "name-desc": res.sort((a,b)=>b.name.localeCompare(a.name)); break;
      case "size": res.sort((a,b)=>b.size - a.size); break;
      case "oldest": res.sort((a,b)=>a.addedAt - b.addedAt); break;
      case "newest":
      default: res.sort((a,b)=>b.addedAt - a.addedAt);
    }
    return res;
  }

  const io = new IntersectionObserver(entries => {
    for (const e of entries){
      if (e.isIntersecting){
        e.target.classList.add("reveal");
        io.unobserve(e.target);
      }
    }
  },{ rootMargin: "80px 0px 120px 0px", threshold: 0.01 });

  function render(){
    const filtered = getFiltered();
    zipBtn.disabled = filtered.length === 0 || state.isZipping;
    clearBtn.disabled = state.items.length === 0;
    drop.classList.toggle("hidden", state.items.length !== 0);

    content.innerHTML = "";

    if (state.view === "grid"){
      const grid = document.createElement("div");
      grid.className = "grid";
      grid.style.gridTemplateColumns = `repeat(auto-fill, minmax(${state.tile}px, 1fr))`;
      content.appendChild(grid);

      filtered.forEach((it, idx) => {
        const card = document.createElement("div");
        card.className = "tile";
        card.style.setProperty("--i", idx);
        card.innerHTML = `
          <button class="thumb" data-action="view" data-idx="${idx}" aria-label="Open ${it.name}">
            <img src="${it.src}" alt="${it.name}" loading="lazy" decoding="async" fetchpriority="low">
          </button>
          <div class="tile-footer">
            <div class="meta">
              <div class="name" title="${it.name}">${it.name}</div>
              <div class="muted">${bytesToNice(it.size)}</div>
            </div>
            <div class="actions">
              <button class="icon-btn" data-action="view" data-idx="${idx}">${svg('eye')}<span class="muted" style="color:inherit">View</span></button>
              <a class="icon-btn" href="${it.src}" download="${it.name}">${svg('download')}<span class="muted" style="color:inherit">Save</span></a>
              <button class="icon-btn" data-action="remove" data-idx="${idx}">${svg('trash-2')}<span class="muted" style="color:inherit">Remove</span></button>
            </div>
          </div>
        `;
        grid.appendChild(card);
        io.observe(card);
      });
    } else {
      const box = document.createElement("div");
      box.className = "list";
      const head = document.createElement("div");
      head.className = "head";
      head.innerHTML = `<div>Name</div><div>Size</div><div>Added</div><div style="text-align:right">Actions</div>`;
      box.appendChild(head);
      filtered.forEach((it, idx)=>{
        const row = document.createElement("div");
        row.className = "row";
        row.style.setProperty("--i", idx);
        row.innerHTML = `
          <div class="row" style="gap:12px">
            <button class="preview" data-action="view" data-idx="${idx}">
              <img src="${it.src}" alt="${it.name}" loading="lazy" decoding="async" fetchpriority="low">
            </button>
            <div>
              <div class="name" title="${it.name}">${it.name}</div>
              <div class="muted">${it.type}</div>
            </div>
          </div>
          <div>${bytesToNice(it.size)}</div>
          <div>${new Date(it.addedAt).toLocaleString()}</div>
          <div style="text-align:right">
            <button class="icon-btn" data-action="view" data-idx="${idx}">${svg('eye')}<span>View</span></button>
            <a class="icon-btn" href="${it.src}" download="${it.name}">${svg('download')}<span>Save</span></a>
            <button class="icon-btn" data-action="remove" data-idx="${idx}">${svg('trash-2')}<span>Remove</span></button>
          </div>
        `;
        box.appendChild(row);
        io.observe(row);
      });
      content.appendChild(box);
      requestAnimationFrame(()=>{
        $$(".list .row", content).forEach((el, i)=>{
          el.style.setProperty("--i", i);
          el.classList.add("reveal");
        });
      });
    }
  }

  function removeAt(filteredIndex){
    const filtered = getFiltered();
    const target = filtered[filteredIndex];
    if (!target) return;
    const idx = state.items.findIndex(it => it.id === target.id);
    if (idx >= 0){
      URL.revokeObjectURL(state.items[idx].src);
      state.items.splice(idx,1);
    }
    if (state.viewer.open){
      const f2 = getFiltered();
      if (!f2.length) { closeViewer(); }
      else { state.viewer.index = Math.max(0, Math.min(state.viewer.index, f2.length-1)); updateViewer(); }
    }
    render();
  }
  function clearAll(){
    state.items.forEach(it => URL.revokeObjectURL(it.src));
    state.items = [];
    closeViewer();
    render();
  }

  function openViewer(filteredIndex){
    const filtered = getFiltered();
    if (!filtered.length) return;
    state.viewer.open = true;
    state.viewer.index = filteredIndex;
    updateViewer();
    lightbox.classList.add("open");
    document.documentElement.style.overflow = "hidden";
  }
  function closeViewer(){
    state.viewer.open = false;
    lightbox.classList.remove("open");
    document.documentElement.style.overflow = "";
  }
  function updateViewer(){
    const filtered = getFiltered();
    const current = filtered[state.viewer.index];
    if (!current){ closeViewer(); return; }
    lbImg.src = current.src;
    lbImg.alt = current.name;
    lbTitle.textContent = current.name + " • " + bytesToNice(current.size);
    lbSave.href = current.src;
    lbSave.download = current.name;
  }

  async function exportZip(){
    const filtered = getFiltered();
    if (!filtered.length || state.isZipping) return;
    state.isZipping = true;
    zipBtn.disabled = true;
    const prev = zipBtn.innerHTML;
    zipBtn.innerHTML = `${svg('loader-2',{class:'spin'})} Creating ZIP…`;

    const nameMap = new Map();
    const uniq = (name) => {
      if (!nameMap.has(name)) { nameMap.set(name,1); return name || "image"; }
      const idx = nameMap.get(name); nameMap.set(name, idx+1);
      const dot = name.lastIndexOf(".");
      if (dot === -1) return name + " ("+idx+")";
      return name.slice(0,dot) + " ("+idx+")" + name.slice(dot);
    };

    try{
      const zip = new JSZip();
      for (const it of filtered){
        const res = await fetch(it.src);
        const blob = await res.blob();
        zip.file(uniq(it.name || "image"), blob);
      }
      const out = await zip.generateAsync({type:"blob", compression:"STORE"});
      const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
      saveAs(out, "images-"+stamp+".zip");
    }catch(err){
      alert("Couldn't create ZIP. Try fewer images or smaller files.");
      console.error(err);
    }finally{
      state.isZipping = false;
      zipBtn.innerHTML = `${svg('archive')} Export ZIP`;
      zipBtn.disabled = getFiltered().length === 0;
    }
  }

  const style = document.createElement("style");
  style.textContent = ".spin{display:inline-block;vertical-align:middle;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}";
  document.head.appendChild(style);

  uploadBtn.addEventListener("click", ()=> fileInput.click());
  fileInput.addEventListener("change", (e)=> addFiles(e.target.files));

  function dropAdd(e){
    e.preventDefault(); e.stopPropagation();
    const files = e.dataTransfer?.files;
    if (files && files.length) addFiles(files);
    drop.classList.remove("highlight");
  }
  ["dragover","dragenter"].forEach(ev => drop.addEventListener(ev, (e)=>{ e.preventDefault(); drop.classList.add("highlight"); }, {passive:false}));
  ["dragleave","dragend","drop"].forEach(ev => drop.addEventListener(ev, (e)=>{ drop.classList.remove("highlight"); }, {passive:true}));
  drop.addEventListener("drop", dropAdd);
  drop.addEventListener("click", ()=> fileInput.click());

  search.addEventListener("input", debounce(()=>{ state.query = search.value; render(); }, 120));
  clearSearch.addEventListener("click", ()=>{ search.value=""; state.query=""; render(); });
  density.addEventListener("input", debounce(()=>{ state.tile = parseInt(density.value,10)||220; render(); }, 60));
  sortSel.addEventListener("change", ()=>{ state.sortBy = sortSel.value; render(); });
  gridBtn.addEventListener("click", ()=>{ state.view="grid"; render(); });
  listBtn.addEventListener("click", ()=>{ state.view="list"; render(); });
  clearBtn.addEventListener("click", clearAll);
  zipBtn.addEventListener("click", exportZip);

  // Delegated actions inside the gallery
  content.addEventListener("click", (e)=>{
    const actionEl = e.target.closest("[data-action]");
    if (!actionEl) return;
    const idx = parseInt(actionEl.getAttribute("data-idx"),10);
    const action = actionEl.getAttribute("data-action");
    if (Number.isNaN(idx)) return;
    if (action === "view") openViewer(idx);
    else if (action === "remove") removeAt(idx);
  });

  // Lightbox controls
  lbClose.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); closeViewer(); });
  lbPrev.addEventListener("click", ()=>{ const f=getFiltered(); state.viewer.index = (state.viewer.index-1+f.length)%f.length; updateViewer(); });
  lbNext.addEventListener("click", ()=>{ const f=getFiltered(); state.viewer.index = (state.viewer.index+1)%f.length; updateViewer(); });
  lightbox.addEventListener("click", (e)=>{
    if (e.target === lightbox) closeViewer();
    if (e.target.closest && e.target.closest("#lb-close")) closeViewer();
  });
  lbRemove.addEventListener("click", ()=>{
    const f=getFiltered();
    const current = f[state.viewer.index];
    if (!current) return;
    const idx = state.items.findIndex(it => it.id === current.id);
    if (idx>=0){
      URL.revokeObjectURL(state.items[idx].src);
      state.items.splice(idx,1);
      const f2=getFiltered();
      if (f2.length === 0) closeViewer();
      else state.viewer.index = Math.max(0, Math.min(state.viewer.index, f2.length-1));
    }
    render();
    if (state.viewer.open) updateViewer();
  });

  // Keyboard navigation
  window.addEventListener("keydown", (e)=>{
    if (!state.viewer.open) return;
    const tag = document.activeElement?.tagName?.toLowerCase();
    if (tag === "input" || tag === "textarea") return;
    if (e.key === "Escape") { e.preventDefault(); return closeViewer(); }
    if (e.key === "ArrowRight" || e.key.toLowerCase() === "d"){
      const f=getFiltered(); state.viewer.index=(state.viewer.index+1)%f.length; updateViewer(); e.preventDefault();
    }
    if (e.key === "ArrowLeft" || e.key.toLowerCase() === "a"){
      const f=getFiltered(); state.viewer.index=(state.viewer.index-1+f.length)%f.length; updateViewer(); e.preventDefault();
    }
  });

  render();
})();
</script>
</body>
</html>
